"use strict";(self.webpackChunkprod=self.webpackChunkprod||[]).push([[350],{70153:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.DOMAIN_MODEL=t.ClassifierKind=void 0,(s=t.ClassifierKind||(t.ClassifierKind={}))[s.CLASS=0]="CLASS",s[s.MIXIN=1]="MIXIN",t.DOMAIN_MODEL="model"},67119:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createClient=void 0;const a=s(41350),o=s(9826),c=s(83595),r=s(65880),i=s(73230);class n extends i.TxProcessor{constructor(e,t,s){super(),this.conn=e,this.connAccount=t,this.notify=s,this.hierarchy=new o.Hierarchy,this.model=new c.ModelDb(this.hierarchy)}txHandler(e,t){const s=e.filter(r.isModelTx);s.forEach((e=>this.hierarchy.tx(e))),s.forEach((e=>{this.model.tx(e)})),t||void 0===this.notify||e.forEach(this.notify)}isDerived(e,t){return this.hierarchy.isDerived(e,t)}async findAll(e,t,s){const a=r.isModelFind(e,this.hierarchy)?this.model:this.conn;return await a.findAll(e,t,s)}async tx(e){var t;await this.conn.tx(e),await(null===(t=this.extraTx)||void 0===t?void 0:t.call(this,e))}async accountId(){return this.connAccount}}class d{constructor(){this.txBuffer=[]}tx(e){var t,s;void 0===this.clientTx?null===(t=this.txBuffer)||void 0===t||t.push(e):null===(s=this.clientTx)||void 0===s||s.call(this,[e],!1)}pretend(e){var t;this.txBuffer=e.concat(null!==(t=this.txBuffer)&&void 0!==t?t:[])}flush(e){var t;this.clientTx=e,this.clientTx(null!==(t=this.txBuffer)&&void 0!==t?t:[],!0),this.txBuffer=void 0}}t.createClient=async function(e,t){const s=new d,o=await e((e=>s.tx(e))),c=await o.accountId(),i=await r.findModelTxs(o,c);s.pretend(i);const l=new n(o,c,t);return s.flush(((e,t)=>l.txHandler(e,t))),await async function(e){const t=await a.DerivedDataProcessor.create(e.model,e.hierarchy,function(e){return{findAll:async(t,s)=>await e.findAll(t,s),tx:async t=>{e.txHandler([t],!1)}}}(e));return e.extraTx=async e=>{await t.tx(e)},e}(l)}},96217:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0});const a=s(98097);t.default=a.component("core",{class:{Obj:"",Doc:"",Class:"",Attribute:"",Tx:"",TxCreateDoc:"",TxUpdateDoc:"",TxRemoveDoc:"",Space:"",Account:"",ShortRef:"",DerivedData:"",DerivedDataDescriptor:"",Title:"",Reference:""},space:{Tx:"",Model:""},account:{System:""},status:{ObjectNotFound:"",ObjectAlreadyExists:"",ItemNotFound:""}})},58134:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DescriptorMap=void 0,t.DescriptorMap=class{constructor(e){this.hierarchy=e,this.class2Descr=new Map,this.descriptors=new Map}getByClass(e){const t=[];for(const s of this.hierarchy.getAncestors(e)){const e=this.class2Descr.get(s);void 0!==e&&e.size>0&&t.push(...e.values())}return t}update(e){this.descriptors.set(e._id,e);let t=this.class2Descr.get(e.sourceClass);void 0===t&&(t=new Map,this.class2Descr.set(e.sourceClass,t)),t.set(e._id,e)}remove(e){const t=this.descriptors.get(e);if(void 0===t)return;const s=this.class2Descr.get(t.sourceClass);void 0!==s&&s.delete(e)}}},77990:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DescriptorMap=t.DerivedDataProcessor=t.registerMapper=void 0;const a=s(58134);Object.defineProperty(t,"DescriptorMap",{enumerable:!0,get:function(){return a.DescriptorMap}});var o=s(61527);Object.defineProperty(t,"registerMapper",{enumerable:!0,get:function(){return o.registerMapper}}),Object.defineProperty(t,"DerivedDataProcessor",{enumerable:!0,get:function(){return o.DerivedDataProcessor}})},61527:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DerivedDataProcessor=t.registerMapper=void 0;const a=s(41350),o=s(73230),c=s(90067),r=s(58134),i=s(22665),n=new Map;t.registerMapper=function(e,t){n.set(e,t)};class d{constructor(e){this.storage=e}async findAll(e,t,s){return await this.storage.findAll(e,t)}async tx(e){var t;const s=await this.storage.tx(e);return await(null===(t=this.processor)||void 0===t?void 0:t.tx(e)),s}}class l extends o.TxProcessor{constructor(e,t,s,a){super(),this.descrs=e,this.model=t,this.hierarchy=s,this.storage=a}clone(e){return new l(this.descrs,this.model,this.hierarchy,e)}static async create(e,t,s){const o=new d(s),c=new l(new r.DescriptorMap(t),e,t,o);o.processor=c;const i=await e.findAll(a.default.class.DerivedDataDescriptor,{});for(const e of i)c.descrs.update(e);return c}async txCreateDoc(e){var t;if(this.hierarchy.isDerived(e.objectClass,a.default.class.DerivedDataDescriptor))return void await this.updateDescriptor(e.objectId,e.modifiedBy);const s=this.descrs.getByClass(e.objectClass),c={resolve:async()=>await Promise.resolve(o.TxProcessor.createDoc2Doc(e))};for(const a of s){let s=null!==(t=await this.applyMapper(a,e))&&void 0!==t?t:await this.applyRule(a,e,c);s=this.withDescrId(s,a._id,e.objectId,e.objectClass),await this.applyDerivedData([],s,e.modifiedBy),await this.applyCollectionRules(a,e,!0)}}extractEmbeddedDoc(e,t){const s=i.getRuleFieldValues(i.sortRules(t),e);return s.length>0?this.extractRuleValues(e,s):e._id}extractRuleValues(e,t){const s={_id:e._id};for(const{rule:e,value:a}of t){const t=this.matchRuleValue(e,a);this.assignValue(s,e.targetField,t)}return s}matchRuleValue(e,t){var s;return void 0!==e.pattern?null===(s=this.processRulePattern(e.pattern,t))||void 0===s?void 0:s[0]:t}async applyCollectionRules(e,t,s){var r,i,n;for(const d of null!==(r=e.collections)&&void 0!==r?r:[])if(s){const s=o.TxProcessor.createDoc2Doc(t),a=s[d.sourceField],r=c.parseFullRef(a);if(void 0!==r&&this.hierarchy.isDerived(r._class,e.targetClass))try{const e=(await this.storage.findAll(r._class,{_id:r._id},{limit:1})).shift();if(void 0!==e){const t=this.extractEmbeddedDoc(s,d.rules),a={$push:{[d.targetField]:t}};await this.updateData(a,e.modifiedBy,e.modifiedOn,e._id,e._class,e.space)}}catch(e){console.log(e)}}else{const s=(null!==(n=null===(i=d.rules)||void 0===i?void 0:i.length)&&void 0!==n?n:0)>0?"._id":"",o=await this.storage.findAll(a.default.class.TxUpdateDoc,{objectClass:e.targetClass,[`operations.\\$push.${d.targetField}${s}`]:t.objectId});for(const e of o)try{const t={$pull:{[d.targetField]:e.operations.$push[d.targetField]}};await this.updateData(t,e.modifiedBy,e.modifiedOn,e.objectId,e.objectClass,e.objectSpace)}catch(e){console.log(e)}}}async updateDescriptor(e,t){this.descrs.remove(e);const s=this.model.getObject(e);this.descrs.update(s),await this.refreshDerivedData(s,t,!0)}async updateData(e,t,s,o,c,r){const i={_id:a.generateId(),_class:a.default.class.TxUpdateDoc,space:a.default.space.Tx,modifiedBy:t,modifiedOn:s,createOn:Date.now(),objectId:o,objectClass:c,objectSpace:r,operations:e};await this.storage.tx(i).catch((e=>console.log(e)))}async txUpdateDoc(e){var t;if(this.hierarchy.isDerived(e.objectClass,a.default.class.DerivedDataDescriptor))return void await this.updateDescriptor(e.objectId,e.modifiedBy);const s=this.descrs.getByClass(e.objectClass),o={resolve:async()=>(await this.storage.findAll(e.objectClass,{_id:e.objectId}))[0]};for(const a of s){const s=null!==(t=await this.applyMapper(a,e))&&void 0!==t?t:await this.applyRule(a,e,o),c=await this.storage.findAll(a.targetClass,{objectId:e.objectId,objectClass:e.objectClass,descriptorId:a._id});await this.applyDerivedData(c,s,e.modifiedBy)}}async txRemoveDoc(e){if(this.hierarchy.isDerived(e.objectClass,a.default.class.DerivedDataDescriptor))return void await this.removeDescriptorDerivedData(e);const t=this.descrs.getByClass(e.objectClass);for(const s of t){const t=await this.storage.findAll(s.targetClass,{objectId:e.objectId,objectClass:e.objectClass,descriptorId:s._id});await this.applyDerivedData(t,[],e.modifiedBy),await this.applyCollectionRules(s,e,!1)}}async removeDescriptorDerivedData(e){const t=this.descrs.descriptors.get(e.objectId);null!=t&&(this.descrs.remove(e.objectId),await this.refreshDerivedData(t,e.modifiedBy,!1))}async applyRule(e,t,s){var a;s.doc=null!==(a=s.doc)&&void 0!==a?a:await s.resolve();const o=i.getRuleFieldValues(i.sortRules(e.rules),s.doc);return 0===o.length?[]:await this.applyRules(e,s.doc,o)}withDescrId(e,t,s,a){for(const o of e)o.descriptorId=t,o.objectId=s,o.objectClass=a;return e}async applyDerivedData(e,t,s){const o=a.withOperations(s,this.storage),{additions:c,updates:r,deletes:n}=i.findExistingData(e,t),d=Promise.all(c.map((async e=>await o.createDoc(e._class,e.space,e,e._id)))),l=Promise.all(r.map((async e=>await o.updateDoc(e._class,e.space,e._id,e)))),u=Promise.all(n.map((async e=>await o.removeDoc(e._class,e.space,e._id))));await Promise.all([d,l,u])}async applyMapper(e,t){var s;const a=n.get(null!==(s=e.mapper)&&void 0!==s?s:"");if(void 0!==a)return await a.map(t,{descriptor:e,hierarchy:this.hierarchy,storage:this.storage,model:this.model})}async applyRules(e,t,s){const a=[];for(const{rule:o,value:c}of s)void 0!==o.pattern?this.processRuleMatches(o.pattern,o.targetField,c,a,t,e):this.assignValue(i.lastOrAdd(a,e,t),o.targetField,c);return a}processRuleMatches(e,t,s,a,o,c){var r;const n=this.processRulePattern(e,s);let d=!1;for(const s of n){d&&a.length>0&&(a.push(i.newDerivedData(o,c,a.length)),d=!1);const n=i.lastOrAdd(a,c,o);this.assignValue(n,t,s),null!==(r=e.multDoc)&&void 0!==r&&r&&(d=!0)}}processRulePattern(e,t){const s=new RegExp(e.pattern,"g");let a;const o=[];for(;null!==(a=s.exec(t));)o.push(i.groupOrValue(e,a));return o}assignValue(e,t,s){void 0!==s&&(e[t]=s)}async refreshDerivedData(e,t,s){var o;const c=await this.storage.findAll(e.sourceClass,{});for(const t of c){const c=await this.storage.findAll(a.default.class.DerivedData,{objectId:t._id,descriptorId:e._id}),r={resolve:async()=>await Promise.resolve(t)},i={_id:a.generateId(),modifiedBy:t.modifiedBy,modifiedOn:t.modifiedOn,createOn:t.createOn,_class:a.default.class.TxCreateDoc,objectClass:t._class,objectId:t._id,space:a.default.space.Tx,objectSpace:t.space,attributes:t},n=s?null!==(o=await this.applyMapper(e,i))&&void 0!==o?o:await this.applyRule(e,i,r):[];await this.applyDerivedData(Array.from(c),n,i.modifiedBy)}}}t.DerivedDataProcessor=l},22665:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getRuleFieldValues=t.sortRules=t.groupOrValue=t.lastOrAdd=t.newDerivedData=t.findExistingData=t.popSameValue=void 0;const a=s(72451),o=s(90067);function c(e,t){const s=t.findIndex((t=>function(e,t){const{_id:s,modifiedOn:o,createOn:c,...r}=e,{_id:i,modifiedOn:n,createOn:d,...l}=t;return a.deepEqual(r,l)}(t,e)));return-1===s||(t.splice(s,1),!1)}function r(e,t,s){var a;return{_class:t.targetClass,objectId:e._id,objectClass:e._class,...null!==(a=t.initiValue)&&void 0!==a?a:{},_id:`dd-${o.generateId()}`,modifiedBy:e.modifiedBy,modifiedOn:Date.now(),createOn:Date.now(),space:e.space,descriptorId:t._id}}function i(e,t){var s,a,o,c;return+(null!==(a=null===(s=e.pattern)||void 0===s?void 0:s.multDoc)&&void 0!==a&&a)-+(null!==(c=null===(o=t.pattern)||void 0===o?void 0:o.multDoc)&&void 0!==c&&c)}t.popSameValue=c,t.findExistingData=function(e,t){const s={additions:[],updates:[],deletes:[]};e.forEach((e=>c(e,t)?s.deletes.push(e):0));for(const e of t){const t=s.deletes.findIndex((t=>t._class===e._class));if(-1!==t){const a=s.deletes.splice(t,1)[0];s.updates.push({...e,_id:a._id})}else s.additions.push(e)}return s},t.newDerivedData=r,t.lastOrAdd=function(e,t,s){return 0===e.length&&e.push(r(s,t,e.length)),e[e.length-1]},t.groupOrValue=function(e,t){var s;return t[null!==(s=e.group)&&void 0!==s?s:0]},t.sortRules=function(e){return[...null!=e?e:[]].sort(i)},t.getRuleFieldValues=function(e,t){const s=[];for(const a of e){const e=t[a.sourceField];void 0!==e&&s.push({rule:a,value:e})}return s}},9826:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Hierarchy=void 0;const a=s(96217);t.Hierarchy=class{constructor(){this.classes=new Map,this.descendants=new Map,this.ancestors=new Map}getAncestors(e){const t=this.ancestors.get(e);if(void 0===t)throw new Error("ancestors not found: "+e);return t}getClass(e){const t=this.classes.get(e);if(void 0===t)throw new Error("class not found: "+e);return t}getDomain(e){const t=this.getClass(e);if(void 0!==t.domain)return t.domain;if(void 0!==t.extends){const e=this.getDomain(t.extends);return t.domain=e,e}throw new Error("domain not found: "+e)}tx(e){if(e._class!==a.default.class.TxCreateDoc)return;const t=e;if(t.objectClass!==a.default.class.Class)return;const s=t.objectId;this.classes.set(s,t.attributes),this.addAncestors(s),this.addDescendant(s)}isDerived(e,t){let s=e;for(;void 0!==s;){if(s===t)return!0;const e=this.classes.get(s);s=null==e?void 0:e.extends}return!1}getDescendants(e){const t=this.descendants.get(e);if(void 0===t)throw new Error("descendants not found: "+e);return t}addDescendant(e){const t=this.getAncestors(e);for(const s of t){const t=this.descendants.get(s);void 0===t?this.descendants.set(s,[e]):t.push(e)}}addAncestors(e){let t=e;for(;void 0!==t;){const s=this.ancestors.get(e);void 0===s?this.ancestors.set(e,[t]):s.push(t);const a=this.classes.get(t);t=null==a?void 0:a.extends}}}},41350:function(e,t,s){var a=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s),Object.defineProperty(e,a,{enumerable:!0,get:function(){return t[s]}})}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),o=this&&this.__exportStar||function(e,t){for(var s in e)"default"===s||Object.prototype.hasOwnProperty.call(t,s)||a(t,e,s)};Object.defineProperty(t,"__esModule",{value:!0}),t._createTestTxAndDocStorage=t._createDoc=t._createClass=t._genMinModel=t.default=void 0,o(s(70153),t),o(s(73230),t),o(s(101),t),o(s(90067),t),o(s(9826),t),o(s(83595),t),o(s(67119),t),o(s(85842),t),o(s(77990),t),o(s(6771),t),o(s(51565),t),o(s(19907),t),o(s(33158),t),o(s(65880),t);var c=s(96217);Object.defineProperty(t,"default",{enumerable:!0,get:function(){return c.default}});var r=s(266);Object.defineProperty(t,"_genMinModel",{enumerable:!0,get:function(){return r._genMinModel}}),Object.defineProperty(t,"_createClass",{enumerable:!0,get:function(){return r._createClass}}),Object.defineProperty(t,"_createDoc",{enumerable:!0,get:function(){return r._createDoc}}),Object.defineProperty(t,"_createTestTxAndDocStorage",{enumerable:!0,get:function(){return r._createTestTxAndDocStorage}})},83595:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ModelDb=t.TxDb=t.MemDb=void 0;const a=s(98097),o=s(96217),c=s(85842),r=s(19907),i=s(73230);class n extends i.TxProcessor{constructor(e){super(),this.objectsByClass=new Map,this.objectById=new Map,this.hierarchy=e}getObjectsByClass(e){const t=this.objectsByClass.get(e);if(void 0===t){const t=[];return this.objectsByClass.set(e,t),t}return t}cleanObjectByClass(e,t){let s=this.objectsByClass.get(e);void 0!==s&&(s=s.filter((e=>e._id!==t)),this.objectsByClass.set(e,s))}getByIdQuery(e,t){var s;const a=[];if("string"==typeof e._id){const t=this.objectById.get(e._id);void 0!==t&&a.push(t)}else if(void 0!==(null===(s=e._id)||void 0===s?void 0:s.$in)){const t=new Set(e._id.$in);for(const e of t){const t=this.objectById.get(e);void 0!==t&&a.push(t)}}return a}getObjectByIdAndClass(e,t){const s=this.getObject(e);if(!this.hierarchy.isDerived(s._class,t))throw new a.PlatformError(new a.Status(a.Severity.ERROR,o.default.status.ObjectNotFound,{_id:e}));return s}getObject(e){const t=this.objectById.get(e);if(void 0===t)throw new a.PlatformError(new a.Status(a.Severity.ERROR,o.default.status.ObjectNotFound,{_id:e}));return t}async findAll(e,t,s){var a;let o;o=!Object.prototype.hasOwnProperty.call(t,"_id")||"string"!=typeof t._id&&void 0===(null===(a=t._id)||void 0===a?void 0:a.$in)?this.getObjectsByClass(e):this.getByIdQuery(t,e);for(const e in t){if(r.shouldSkipId(e,t))continue;const s=t[e];o=r.findProperty(o,e,s)}void 0!==(null==s?void 0:s.sort)&&r.resultSort(o,null==s?void 0:s.sort);const c=o.length;return o=o.slice(0,null==s?void 0:s.limit),Object.assign(o,{total:c})}addDoc(e){if(void 0!==this.objectById.get(e._id))throw new a.PlatformError(new a.Status(a.Severity.ERROR,o.default.status.ObjectAlreadyExists,{_id:e._id}));this.hierarchy.getAncestors(e._class).forEach((t=>{this.getObjectsByClass(t).push(e)})),this.objectById.set(e._id,e)}delDoc(e){const t=this.getObject(e);this.objectById.delete(e),this.hierarchy.getAncestors(t._class).forEach((t=>{this.cleanObjectByClass(t,e)}))}}t.MemDb=n,t.TxDb=class extends n{async tx(e){this.addDoc(e)}},t.ModelDb=class extends n{async txCreateDoc(e){this.addDoc(i.TxProcessor.createDoc2Doc(e))}async txUpdateDoc(e){const t=this.getObjectByIdAndClass(e.objectId,e.objectClass),s=e.operations;for(const e in s)e.startsWith("$")?c.getOperator(e)(t,s[e]):t[e]=s[e];t.modifiedBy=e.modifiedBy,t.modifiedOn=e.modifiedOn}async txRemoveDoc(e){this.delDoc(e.objectId)}}},266:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t._createTestTxAndDocStorage=t._genMinModel=t._createDoc=t._createClass=void 0;const a=s(70153),o=s(96217),c=s(51565),r=s(73230),i=s(90067);function n(e,t,s){return{_id:i.generateId(),_class:o.default.class.TxCreateDoc,objectId:e,objectClass:o.default.class.Class,attributes:{kind:a.ClassifierKind.CLASS,domain:s,...t},modifiedBy:o.default.account.System,modifiedOn:Date.now(),createOn:Date.now(),objectSpace:o.default.space.Model,space:o.default.space.Tx}}function d(e,t,s,a){return{_id:i.generateId(),_class:o.default.class.TxCreateDoc,space:o.default.space.Tx,modifiedBy:null!=a?a:o.default.account.System,modifiedOn:Date.now(),createOn:Date.now(),objectId:null!=s?s:i.generateId(),objectClass:e,objectSpace:o.default.space.Model,attributes:t}}t._createClass=n,t._createDoc=d,t._genMinModel=function(){const e=[];e.push(n(o.default.class.Obj,{},a.DOMAIN_MODEL)),e.push(n(o.default.class.Doc,{extends:o.default.class.Obj})),e.push(n(o.default.class.Class,{extends:o.default.class.Doc})),e.push(n(o.default.class.Space,{extends:o.default.class.Doc})),e.push(n(o.default.class.Account,{extends:o.default.class.Doc})),e.push(n(o.default.class.Reference,{extends:o.default.class.Doc},c.DOMAIN_REFERENCES)),e.push(n(o.default.class.DerivedData,{extends:o.default.class.Doc})),e.push(n(o.default.class.DerivedDataDescriptor,{extends:o.default.class.Doc})),e.push(n(o.default.class.Title,{extends:o.default.class.DerivedData})),e.push(n(o.default.class.ShortRef,{extends:o.default.class.Doc},c.DOMAIN_REFERENCES)),e.push(n(o.default.class.Tx,{extends:o.default.class.Doc},r.DOMAIN_TX)),e.push(n(o.default.class.TxCreateDoc,{extends:o.default.class.Tx})),e.push(n(o.default.class.TxUpdateDoc,{extends:o.default.class.Tx})),e.push(n(o.default.class.TxRemoveDoc,{extends:o.default.class.Tx}));const t="User1",s="User2";return e.push(d(o.default.class.Account,{email:"user1@site.com",name:"User1"},t),d(o.default.class.Account,{email:"user2@site.com",name:"User2"},s),d(o.default.class.Space,{name:"Sp1",description:"",private:!1,members:[t,s]}),d(o.default.class.Space,{name:"Sp2",description:"",private:!1,members:[t]})),e};var l=s(56566);Object.defineProperty(t,"_createTestTxAndDocStorage",{enumerable:!0,get:function(){return l._createTestTxAndDocStorage}})},56566:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t._createTestTxAndDocStorage=void 0;const a=s(96217),o=s(73230);class c{constructor(e,t,s){this.hierarchy=e,this.txStore=t,this.doc=s}async accountId(){return a.default.account.System}txStorage(){return this.txStore}async findAll(e,t,s){return this.hierarchy.getDomain(e)===o.DOMAIN_TX?await this.txStore.findAll(e,t,s):await this.doc.findAll(e,t,s)}async tx(e){await this.doc.tx(e),await this.txStore.tx(e)}}t._createTestTxAndDocStorage=function(e,t,s){return new c(e,t,s)}},65880:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.generateModelDiff=t.buildModel=t.findModelTxs=t.isModelFind=t.isModelTx=void 0;const a=s(70153),o=s(96217),c=s(9826),r=s(83595),i=s(90067),n=s(72451);async function d(e){e=e.filter((e=>e.modifiedBy===o.default.account.System));const t=new c.Hierarchy,s=new r.ModelDb(t);e.forEach(t.tx.bind(t));for(const t of e)await s.tx(t);return{hierarchy:t,model:s}}t.isModelTx=function(e){return e.objectSpace===o.default.space.Model},t.isModelFind=function(e,t){return t.getDomain(e)===a.DOMAIN_MODEL},t.findModelTxs=async function(e,t){return await e.findAll(o.default.class.Tx,{objectSpace:o.default.space.Model})},t.buildModel=d,t.generateModelDiff=async function(e,t){const{model:s}=await d(e),{model:a}=await d(t),c=new Map((await s.findAll(o.default.class.Doc,{})).map((e=>[e._id,e]))),r=new Map((await a.findAll(o.default.class.Doc,{})).map((e=>[e._id,e]))),l=[];return c.forEach(function(e,t){return(s,a)=>{const c=e.get(a);if(void 0!==c){const{_id:e,_class:a,modifiedBy:r,modifiedOn:d,space:l,createOn:u,...f}=c,{_id:p,_class:h,modifiedBy:D,modifiedOn:y,createOn:v,space:b,...g}=s,_=function(e,t){const s={},a=new Map(Object.entries(e)),o=new Map(Object.entries(t));for(const[e,t]of a){const a=o.get(e);n.deepEqual(a,t)||(s[e]=a)}for(const[e,t]of o)void 0===a.get(e)&&void 0!==t&&(s[e]=t);return s}(g,f);if(Object.keys(_).length>0){const s={_id:i.generateId(),_class:o.default.class.TxUpdateDoc,space:o.default.space.Tx,modifiedBy:o.default.account.System,modifiedOn:Date.now(),createOn:Date.now(),objectId:e,objectClass:a,objectSpace:l,operations:_};t.push(s)}}else{const e={_id:i.generateId(),_class:o.default.class.TxRemoveDoc,space:o.default.space.Tx,modifiedBy:o.default.account.System,modifiedOn:Date.now(),createOn:Date.now(),objectId:a,objectClass:s._class,objectSpace:s.space};t.push(e)}}}(r,l)),r.forEach(function(e,t){return(s,a)=>{if(!e.has(a)){const{_class:e,modifiedBy:c,modifiedOn:r,space:n,...d}=s,l={_id:i.generateId(),_class:o.default.class.TxCreateDoc,space:o.default.space.Tx,modifiedBy:s.modifiedBy,modifiedOn:s.modifiedOn,createOn:s.createOn,objectId:a,objectClass:s._class,objectSpace:s.space,attributes:d};t.push(l)}}}(c,l)),l}},85842:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getOperator=void 0;const a=s(72451),o={$push:function(e,t){const s=e;for(const e in t){const a=s[e];void 0===a?s[e]=[t[e]]:a.push(t[e])}},$pull:function(e,t){const s=e;for(const e in t){const o=s[e];void 0!==o&&(s[e]=o.filter((s=>!a.deepEqual(s,t[e]))))}}};t.getOperator=function(e){const t=o[e];if(void 0===t)throw new Error("unknown operator: "+e);return t}},50085:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createPredicates=t.isPredicate=void 0;const a=s(19907),o={$in:(e,t)=>{if(!Array.isArray(e))throw new Error("$in predicate requires array");return s=>{const a=[];for(const o of s)e.includes(o[t])&&a.push(o);return a}},$like:(e,t)=>s=>{const o=[];for(const c of s){const s=c[t];a.checkLikeQuery(s,e)&&o.push(c)}return o},$ne:(e,t)=>s=>{const o=[];for(const c of s){const s=c[t];e===s||a.nestedDotQueryCheck(t,c,e)||o.push(c)}return o}};t.isPredicate=function(e){const t=Object.keys(e);return t.length>0&&t.every((e=>e.startsWith("$")))},t.createPredicates=function(e,t){const s=Object.keys(e),a=[];for(const c of s){const r=o[c];if(void 0===r)throw new Error("unknown predicate: "+s[0]);a.push(r(e[c],t))}return a}},19907:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.shouldSkipId=t.matchDocument=t.resultSort=t.nestedDotQueryCheck=t.findProperty=t.checkLikeQuery=t.likeSymbol=void 0;const a=s(72451),o=s(50085);function c(e,t,s){if(void 0===s)return e;if(o.isPredicate(s)){const a=o.createPredicates(s,t);for(const t of a)e=t(e);return e}const c=[];for(const o of e){const e=o[t];(a.deepEqual(e,s)||r(t,o,s))&&c.push(o)}return c}function r(e,t,s){const a=(e=e.split("\\$").join("$")).split(".");if(a.length>1){for(const e of a)t=null==t?void 0:t[e];if(t===s)return!0}return!1}function i(e,t){var s;return"_id"===e&&void 0===(null===(s=t._id)||void 0===s?void 0:s.$like)}t.likeSymbol="%",t.checkLikeQuery=function(e,s){const a=s.split(t.likeSymbol).join(".*");return RegExp(`^${a}$`).test(e)},t.findProperty=c,t.nestedDotQueryCheck=r,t.resultSort=function(e,t){e.sort(((e,s)=>{for(const a in t){const o="string"==typeof e[a]?e[a].localeCompare(s[a]):e[a]-s[a];if(0!==o)return o*t[a]}return 0}))},t.matchDocument=function(e,t){let s=[e];for(const e in t)i(e,t)||(s=c(s,e,t[e]));return 1===s.length},t.shouldSkipId=i},51565:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DOMAIN_REFERENCES=void 0,t.DOMAIN_REFERENCES="references"},33158:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.createShortRef=void 0;const a=s(96217),o=s(90067);async function c(e){var t;if((null===(t=null==e?void 0:e.status)||void 0===t?void 0:t.code)!==a.default.status.ObjectAlreadyExists)throw console.log(e),e;await async function(){return await new Promise((e=>{setTimeout((()=>{e()}),5+Math.round(100*Math.random()))}))}()}t.createShortRef=async function(e,t,s,r,i,n){var d;let l=0,u=-1;for(;;){const f=(null!==(d=(await e.findAll(a.default.class.ShortRef,{namespace:n},{limit:1,sort:{counter:-1}}))[0])&&void 0!==d?d:{counter:0}).counter+1+l;f===u&&l++;const p=`${n}-${f}`;if(u=f,(await e.findAll(a.default.class.ShortRef,{_id:p},{limit:1})).length>0){l+=1;continue}const h={_id:o.generateId(),_class:a.default.class.TxCreateDoc,space:a.default.space.Tx,modifiedBy:t,modifiedOn:Date.now(),createOn:Date.now(),objectId:p,objectClass:a.default.class.ShortRef,objectSpace:s,attributes:{descriptorId:"#shortRef",objectId:r,objectClass:i,namespace:n,counter:f,title:p}};try{return await e.tx(h),p}catch(e){await c(e)}}}},101:(e,t)=>{var s;Object.defineProperty(t,"__esModule",{value:!0}),t.SortingOrder=void 0,(s=t.SortingOrder||(t.SortingOrder={}))[s.Ascending=1]="Ascending",s[s.Descending=-1]="Descending"},6771:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},73230:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.newTxCreateDoc=t.withOperations=t.TxProcessor=t.txObjectClass=t.DOMAIN_TX=void 0;const a=s(96217),o=s(33158),c=s(90067);t.DOMAIN_TX="tx";const r=[a.default.class.TxCreateDoc,a.default.class.TxUpdateDoc,a.default.class.TxRemoveDoc];t.txObjectClass=function(e){if(r.includes(e._class))return e.objectClass};class i{constructor(){this.txHandlers={[a.default.class.TxCreateDoc]:async e=>await this.txCreateDoc(e),[a.default.class.TxUpdateDoc]:async e=>await this.txUpdateDoc(e),[a.default.class.TxRemoveDoc]:async e=>await this.txRemoveDoc(e)}}async tx(e){var t,s;return await(null===(s=(t=this.txHandlers)[e._class])||void 0===s?void 0:s.call(t,e))}static createDoc2Doc(e){return{_id:e.objectId,_class:e.objectClass,space:e.objectSpace,modifiedBy:e.modifiedBy,modifiedOn:e.modifiedOn,createOn:e.createOn,...e.attributes}}async txCreateDoc(e){}async txUpdateDoc(e){}async txRemoveDoc(e){}}function n(e,t,s,o,r,i){return{_id:c.generateId(),_class:a.default.class.TxCreateDoc,space:d(e,i),modifiedBy:e,modifiedOn:Date.now(),createOn:Date.now(),objectId:null!=r?r:c.generateId(),objectClass:t,objectSpace:s,attributes:o}}function d(e,t){return null!=t&&t?a.default.space.Tx+"#"+e:a.default.space.Tx}t.TxProcessor=i,t.withOperations=function(e,t){const s=t;return s.accountId=()=>e,s.createDoc=async(s,a,o,c,r)=>{const d=n(e,s,a,o,c,r);return await t.tx(d),i.createDoc2Doc(d)},s.createShortRef=async(s,c,r)=>{const i=(await t.findAll(a.default.class.Space,{_id:r},{limit:1}))[0].name.trim().toUpperCase().replace(/[^a-z0-9]/gim,"_").replace(/[_]/g,"_");return await o.createShortRef(t,e,r,s,c,i)},s.updateDoc=async(s,o,r,i,n)=>{const l={_id:c.generateId(),_class:a.default.class.TxUpdateDoc,space:d(e,n),modifiedBy:e,modifiedOn:Date.now(),createOn:Date.now(),objectId:r,objectClass:s,objectSpace:o,operations:i};await t.tx(l)},s.removeDoc=async(s,o,r,i)=>{const n={_id:c.generateId(),_class:a.default.class.TxRemoveDoc,space:d(e,i),modifiedBy:e,modifiedOn:Date.now(),createOn:Date.now(),objectId:r,objectClass:s,objectSpace:o};await t.tx(n)},s},t.newTxCreateDoc=n},90067:(e,t)=>{function s(e,t){const s=e.toString(16);return s.length<t?"0".repeat(t-s.length)+s:s}Object.defineProperty(t,"__esModule",{value:!0}),t.parseFullRef=t.getFullRef=t.generateId=void 0;let a=Math.random()*(1<<24)|0;const o=s(Math.random()*(1<<24)|0,6)+s(65536*Math.random()|0,4);t.generateId=function(){return s(Date.now()/1e3|0,8)+o+s(16777215&a++,6)},t.getFullRef=function(e,t){return JSON.stringify({_id:e,_class:t})},t.parseFullRef=function(e){return JSON.parse(e)}}}]);